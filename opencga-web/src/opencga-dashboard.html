<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<link rel="import" href="../lib/jsorolla/src/lib/opencga/catalog/opencga-projects.html">
<link rel="import" href="opencga-widget.html">

<dom-module id="opencga-dashboard">
    <template>
        <style is="custom-style" include="jso-styles"></style>
        <style>
            .center {
                margin: auto;
                display: block;
                text-align: justify;
                max-width: 95%;
                font-size: 18px;
                color: #797979;
            }

            dt {
                float: left;
                clear: left;
                text-align: right;
                width: 15%;
                color: #645a5a;
            }

            dd {
                float: left;
                margin-left: 1em;
                color: #999
            }
        </style>

        <div class="row center">
            <!--LEFT-->
            <div>
                <h1>User</h1>
                <dl>
                    <dt>Name</dt>
                    <dd>{{_userInfo.name}}</dd>
                    <dt>Email</dt>
                    <dd>{{_userInfo.email}}</dd>
                    <dt>Organization</dt>
                    <dd>{{_userInfo.organization}}</dd>
                    <dt>Account type</dt>
                    <dd>{{_userInfo.account.type}}</dd>
                    <dt>Date</dt>
                    <dd>{{_userInfo.account.creationDate}}</dd>
                </dl>
            </div>

            <div style="clear: both; padding-top: 10px;">
                <div class="col-md-6">
                    <div class="panel panel-primary">
                        <div class="panel-heading">Configurations</div>
                        <div class="panel-body" style="max-height: 300px; overflow-y: auto">
                            <template is="dom-if" if="{{_notEmpty(_userInfo.configs)}}">
                                <template is="dom-repeat" items="{{_userInfo.configs}}" as="config">
                                    <div style="margin: 5px;">
                                        <a class="fa fa-caret-down" role="button" data-toggle="collapse" aria-hidden="true"
                                           href="#{{prefix}}{{config.name}}" aria-expanded="false" aria-controls="{{prefix}}{{config.name}}"></a>
                                        <span style="font-weight: bold"> {{config.name}}</span>
                                        <div class="collapse" id="{{prefix}}{{config.name}}" style="padding: 2px 15px; font-size: initial;">
                                            {{json2string(config.content)}}
                                        </div>
                                    </div>
                                </template>
                            </template>
                            <template is="dom-if" if="{{!_notEmpty(_userInfo.configs)}}">
                                No configs found.
                            </template>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="panel panel-primary">
                        <div class="panel-heading">Filters</div>
                        <div class="panel-body" style="max-height: 300px; overflow-y: auto">
                            <template is="dom-if" if="{{_notEmpty(_userInfo.filters)}}">
                                <template is="dom-repeat" items="{{_userInfo.filters}}" as="filter">
                                    <div style="margin: 5px; clear: both;">
                                        <a class="fa fa-caret-down" role="button" data-toggle="collapse" aria-hidden="true"
                                           href="#{{prefix}}{{filter.name}}" aria-expanded="false" aria-controls="{{prefix}}{{filter.name}}"></a>
                                        <span style="font-weight: bold"> {{filter.name}}</span>
                                        <div class="collapse" id="{{prefix}}{{filter.name}}" style="padding: 2px 15px; font-size: initial;">
                                            <dl>
                                                <dt>Name</dt>
                                                <dd>{{filter.name}}</dd>
                                                <dt>Description</dt>
                                                <dd>{{filter.description}}</dd>
                                                <dt>Bioformat</dt>
                                                <dd>{{filter.bioformat}}</dd>
                                                <dt>Query</dt>
                                                <dd>{{json2string(filter.query)}}</dd>
                                                <dt>Options</dt>
                                                <dd>{{json2string(filter.options)}}</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </template>
                            </template>
                            <template is="dom-if" if="{{!_notEmpty(_userInfo.filters)}}">
                                No filters found.
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            <div style="clear: both; margin: 5px 10px">
                <opencga-projects opencga-client="{{opencgaClient}}" projects="{{projects}}" hide-text on-project="updateProject">
                </opencga-projects>
            </div>
        </div>

    </template>
    <script>
        Polymer({
            is: 'opencga-dashboard',
            properties: {
                opencgaClient: {
                    type: Object,
                    observer: 'opencgaClientChanged'
                },
                projects: {
                    type: Array
                }
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = Utils.randomString(6);
                }
                this._userInfo = {}
            },
            opencgaClientChanged: function(client) {
                if (client !== undefined && client instanceof OpenCGAClient) {
                    let _this = this;
                    client.users().info({exclude: "projects"}).then(function(data) {
                        let tmp = data.response[0].result[0];
                        // Move filters from configs.filters to filters
                        if (tmp.configs.hasOwnProperty("filters")) {
                            tmp.filters = tmp.configs.filters;
                            delete tmp.configs.filters;
                        }
                        // Fix the config to be an array
                        let configArray = [];
                        for (key in tmp.configs) {
                            configArray.push({
                                name: key,
                                content: tmp.configs[key]
                            });
                        }
                        tmp.configs = configArray;
                        _this._userInfo = tmp;
                    })
                }
            },
            _notEmpty: function(element) {
                if (element === undefined || element.length === 0) {
                    return false;
                }
                return true;
            },
            json2string: function(data) {
                return JSON.stringify(data);
            }
        });

    </script>
</dom-module>
